# Bitcoin Core USDT Tracing Dashboard

A NixOS configuration that deploys a Bitcoin Core node with USDT tracepoint monitoring. A BCC/eBPF script hooks into bitcoind's 16 USDT tracepoints, exports metrics to Prometheus, and visualizes them on a public Grafana dashboard over HTTPS.

## Architecture

```
bitcoind (USDT tracepoints)
    |
    v  eBPF/BCC hooks
Python tracing exporter (root, systemd)  :9435
    |
    v  Prometheus scrape
Prometheus  :9090
    |
    v  data source
Grafana  :3000 (anonymous read-only)
    |
    v  reverse proxy
Caddy  :443 (Cloudflare DNS ACME)
```

## Tracepoints

The exporter hooks into 16 of bitcoind's 20 USDT tracepoints (excluding `coin_selection:*`):

- **Mempool (4):** added, removed, replaced, rejected
- **Network (7):** inbound/outbound messages, inbound/outbound/closed connections, evicted, misbehaving
- **Validation (1):** block_connected
- **UTXO Cache (4):** flush, add, spent, uncache

## Deploying Your Own

### Prerequisites

- A VPS running NixOS (tested on Hetzner Cloud CX22)
- [sops](https://github.com/getsops/sops) and [age](https://github.com/FiloSottile/age) installed locally
- A Cloudflare API token with DNS edit permissions for your domain
- [just](https://github.com/casey/just) command runner

### 1. Clone and configure

```sh
git clone <this-repo>
cd usdt-dash
```

### 2. Update network settings

Edit `configuration.nix` and change to match your server:

- `networking.hostName` -- your hostname
- `networking.interfaces.enp1s0.ipv4.addresses` -- your server's IP
- `networking.defaultGateway` -- your provider's gateway
- `users.users.root.openssh.authorizedKeys.keys` -- your SSH public key

### 3. Update Caddy/Grafana domain

In `configuration.nix`, replace `tracing.fish.foo` with your domain in:

- `services.grafana.settings.server.root_url`
- `services.caddy.virtualHosts."..."`

### 4. Update justfile

In `justfile`, set `host` to your server's IP or hostname.

### 5. Set up secrets

The included `secrets.yaml` is encrypted with keys you can't decrypt. Delete it and create your own:

```sh
# Generate a local age key (skip if you already have one)
age-keygen -o ~/.config/sops/age/keys.txt

# Get your local public key
age-keygen -y ~/.config/sops/age/keys.txt
```

Edit `.sops.yaml` and replace both keys:
- `&local` -- your local age public key
- `&server` -- leave as placeholder for now (filled after first deploy)

```yaml
keys:
  - &local age1your-local-key-here
  - &server age1your-server-key-here
creation_rules:
  - path_regex: secrets\.yaml$
    key_groups:
      - age:
          - *local
          - *server
```

For the initial deploy, temporarily comment out the `&server` key and its reference so you can encrypt with just your local key:

```sh
rm secrets.yaml

# Create plaintext, then encrypt in-place
cat > secrets.yaml <<'EOF'
caddy-cloudflare-token: your-cloudflare-api-token
grafana-secret-key: some-random-hex-string
EOF
sops --encrypt --in-place secrets.yaml
```

### 6. Initial deploy

```sh
just deploy
```

This uses nixos-anywhere to wipe and install NixOS on the target.

### 7. Add server key to sops

sops-nix automatically derives an age key from the server's SSH host key for decryption -- no manual key generation needed on the server. But you need the corresponding *public* key in `.sops.yaml` so that `sops` can encrypt secrets the server can read.

Get the age public key from the server's SSH host key:

```sh
ssh root@<your-server> "cat /etc/ssh/ssh_host_ed25519_key.pub" | nix-shell -p ssh-to-age --run ssh-to-age
```

Paste the output into `.sops.yaml` as the `&server` key, uncomment it, then re-encrypt:

```sh
echo y | sops updatekeys secrets.yaml
```

### 8. Deploy the full configuration

```sh
just switch
```

This rsyncs the config to the server and runs `nixos-rebuild switch` remotely.

### 9. Reboot

The first deploy with kernel header changes needs a reboot for BCC to find them:

```sh
ssh root@<your-server> reboot
```

After reboot, verify:
```sh
# Check tracing service
ssh root@<your-server> systemctl status bitcoind-tracing

# Check metrics endpoint
ssh root@<your-server> curl -s localhost:9435/metrics | head -20
```

## File Overview

| File | Purpose |
|---|---|
| `flake.nix` | Nix flake with nixpkgs, disko, and sops-nix inputs |
| `configuration.nix` | All NixOS services: bitcoind, tor, prometheus, grafana, caddy, sops |
| `disk-config.nix` | Disk partitioning layout (disko) |
| `hardware-configuration.nix` | Hardware-specific config (generated by nixos-anywhere) |
| `tracing/bitcoind_exporter.py` | BCC/eBPF script hooking USDT tracepoints, Prometheus exporter |
| `tracing/service.nix` | NixOS module for the tracing systemd service |
| `grafana/dashboard.json` | Grafana dashboard with mempool, network, block, and UTXO cache panels |
| `.sops.yaml` | sops encryption key configuration |
| `secrets.yaml` | Encrypted secrets (Cloudflare token, Grafana secret key) |
| `justfile` | Command runner recipes for deploy, switch, sync, etc. |
